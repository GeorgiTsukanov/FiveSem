
Процедура ОбработкаПроведения(Отказ, Режим)
	//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	
	
	
	запрос = Новый запрос;
	запрос.Текст = "ВЫБРАТЬ
	               |	РасходнаяНакладнаяТовары.Номенклатура КАК Номенклатура,
	               |	СУММА(РасходнаяНакладнаяТовары.Количество) КАК Количество,
	               |	СУММА(РасходнаяНакладнаяТовары.Сумма) КАК Сумма
	               |ПОМЕСТИТЬ ВТТовары
	               |ИЗ
	               |	Документ.РасходнаяНакладная.Товары КАК РасходнаяНакладнаяТовары
	               |ГДЕ
	               |	РасходнаяНакладнаяТовары.Ссылка = &Ссылка
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	РасходнаяНакладнаяТовары.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТТовары.Номенклатура КАК Номенклатура,
	               |	ВТТовары.Номенклатура.ТипНоменклатуры КАК ТипНоменклатуры,
	               |	ВТТовары.Количество КАК Количество,
	               |	ВТТовары.Сумма КАК Сумма,
	               |	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
	               |	ЕСТЬNULL(ОстаткиТоваровОстатки1.КоличествоОстаток, 0) КАК КоличествоОстаток1,
	               |	ЕСТЬNULL(СебестоимостьТовараОстатки.СуммаОстаток, 0) КАК СуммаОстаток
	               |ИЗ
	               |	ВТТовары КАК ВТТовары
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиТоваров.Остатки(&ДатаАктуальности, Склад = &Склад) КАК ОстаткиТоваровОстатки
	               |		ПО ВТТовары.Номенклатура = ОстаткиТоваровОстатки.Номенклатура
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиТоваров.Остатки КАК ОстаткиТоваровОстатки1
	               |		ПО ВТТовары.Номенклатура = ОстаткиТоваровОстатки1.Номенклатура
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТовара.Остатки КАК СебестоимостьТовараОстатки
	               |		ПО ВТТовары.Номенклатура = СебестоимостьТовараОстатки.Номенклатура";
			
	запрос.УстановитьПараметр("Ссылка", Ссылка);
	запрос.УстановитьПараметр("ДатаАктуальности", Дата);
	запрос.УстановитьПараметр("Склад", Склад);

	РезЗапроса = Запрос.Выполнить();
	выборка = РезЗапроса.Выбрать();
	Движения.Продажи.Записывать = Истина;	
	себестоимость = 0;

	Пока выборка.Следующий() Цикл
		Если выборка.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Товары тогда
			Если выборка.Количество > выборка.КоличествоОстаток тогда 
				сообщить("Количество товаров на складе меньше количества товаров в накладной " + выборка.Номенклатура );
				отказ = истина;	
			Иначе 
				Движение = Движения.ОстаткиТоваров.Добавить();
				Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
				Движение.Период = Дата;
				Движение.Номенклатура = выборка.Номенклатура;
				Движение.Склад = Склад;
				Движение.Количество = выборка.Количество;
				
				Движение = Движения.СебестоимостьТовара.Добавить();	
				Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
				Движение.Период = Дата;		
				Движение.Номенклатура = выборка.Номенклатура;	
				Если выборка.КоличествоОстаток1 = выборка.Количество Тогда 
					Движение.Сумма = выборка.СуммаОстаток;
					себестоимость = себестоимость + выборка.СуммаОстаток;
				Иначе
					Движение.Сумма = (выборка.СуммаОстаток / выборка.КоличествоОстаток1) * выборка.Количество;
					себестоимость = себестоимость + (выборка.СуммаОстаток / выборка.КоличествоОстаток1) * выборка.Количество;
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
		
		
		Движения.СебестоимостьТовара.Записывать = Истина;
		Движение = Движения.Продажи.Добавить();
		Движение.Период = Дата;
		Движение.Номенклатура = выборка.Номенклатура;
		Движение.Контрагент = Контрагент;
		Движение.Сумма = выборка.Сумма;
		//
		Движение.Себестоимость = себестоимость;    
		
		
		Движения.Взаиморасчеты.Записывать = Истина;
		Движение = Движения.Взаиморасчеты.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.Контрагент = Контрагент;
		Движение.Договор = Договор;
		Движение.Сумма = выборка.Сумма;
	КонецЦикла;
	
	//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры

